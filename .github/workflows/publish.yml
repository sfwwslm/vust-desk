name: Publish

on:
  workflow_call:
    inputs:
      app_version:
        type: string
        description: The version of the app.
        required: false
        default: "0.0.0"
      release_name:
        type: string
        description: The name of the release.
        required: false
        default: Release
      release_tag:
        type: string
        description: The tag to use for the release.
        required: true
      prerelease:
        type: boolean
        description: Whether to make the release a prerelease.
        required: false
        default: false
      delete_release:
        type: boolean
        description: Whether to delete the release before creating a new one.
        required: false
        default: true
      task_build:
        type: string
        description: The task to run for building the app.
        required: false
        default: "tauri build"
    secrets:
      TAURI_SIGNING_PRIVATE_KEY:
        description: Sign app binaries for updater support.
        required: false
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD:
        description: Password for the signing key.
        required: false
      BUILD_ENV:
        description: "Environment variables to pass to the build process. Format: `key1=value1\\nkey2=value2\\n...`."
        required: false

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取所有历史记录以生成更新日志

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 在创建前先删除已存在的 Release
      - name: Delete existing release
        if: inputs.delete_release == true
        run: |
          gh release delete ${{ inputs.release_tag }} --yes --cleanup-tag || true
          sleep 1

      - name: Create release
        env:
          tag: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name }}
        run: |
          gh release create "$tag" --title "$name" --notes "See commit history for details." ${{ inputs.prerelease == true && '--prerelease' || '' }}

  publish-tauri:
    needs: [create-release]
    permissions:
      contents: write
    # 使用 strategy.matrix 支持多平台构建
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "ubuntu-22.04"
            # 定义 Linux 平台需要上传的产物路径和格式
            dist: "src-tauri/target/release/bundle/**/*.{deb,deb.sig}"
          - platform: "windows-latest"
            # 定义 Windows 平台需要上传的产物路径
            dist: "src-tauri/target/release/bundle"

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 为 Linux 环境安装必要的系统依赖
      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      - name: Install frontend dependencies
        run: pnpm install --no-frozen-lockfile

      # 使用跨平台兼容的方式写入环境变量
      - name: Write BUILD_ENV to .env file
        run: echo "${{ secrets.BUILD_ENV }}" > .env

      - name: Build application
        run: pnpm ${{ inputs.task_build }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      # 根据不同平台执行不同的上传逻辑
      - name: Linux - Upload Artifacts
        if: matrix.platform == 'ubuntu-22.04'
        run: gh release upload ${{ inputs.release_tag }} ${{ matrix.dist }} --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Windows - Upload Artifacts
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          # PowerShell 的方式是先用 Get-ChildItem 找到所有文件
          $files = Get-ChildItem -Path ${{ matrix.dist }} -Recurse -Include "*.exe", "*.sig" | Select-Object -ExpandProperty FullName

          if ($null -eq $files) {
            Write-Error "No artifacts found to upload."
            exit 1
          }

          gh release upload ${{ inputs.release_tag }} $files --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
